<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Objectselector Creator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheets/style.css" type="text/css">
    <link rel="shortcut icon" type="image/png" href="/favicon.ico"/>
</head>
<body>
<!-- Libraries -->
<script src="javascripts/libraries/three.js"></script>
<script src="javascripts/libraries/OrbitControls.js"></script>
<script src="javascripts/libraries/TransformControls.js"></script>
<script src="javascripts/libraries/GLTFLoader.js"></script>
<script src="javascripts/libraries/OBJLoader.js"></script>
<script src="javascripts/libraries/FBXLoader.js"></script>
<script src="javascripts/libraries/GeometryUtils.js"></script>
<script src="javascripts/libraries/inflate.min.js"></script>
<script src="javascripts/libraries/MTLLoader.js"></script>
<script src="javascripts/libraries/GLTFExporter.js"></script>
<!-- Funtions scripts -->
<script src="javascripts/ObjectsCreation.js"></script>
<script src="javascripts/TextCreation.js"></script>
<script src="javascripts/ObjectsUtils.js"></script>
<script src="javascripts/Controls.js"></script>
<script src="javascripts/Classes.js"></script>
<script src="javascripts/DragAndDropManagement.js"></script>
<script src="javascripts/LoadManager.js"></script>
<script src="javascripts/ExportManager.js"></script>
<script src="javascripts/ObjectsUtils.js"></script>

<div id="control">
    <a href="javascript:control.setMode( 'translate' );">"W" bouger</a> |
    <a href="javascript:control.setMode( 'rotate' );">"E" orienter</a> |
    <a href="javascript:control.setMode( 'scale' );">"R" échelle</a> |
    <!-- <a href="javascript:control.setSpace( control.space === 'local' ? 'world' : 'local' );">
        "Q" toggle world/local space</a><br />
    Hold "Ctrl" down to snap to grid |-->
    <a href="javascript:switchObjectControl();">"S" changer d'objet</a> |
    <a href="javascript:removeObject();">"Delete" supprimer</a>
</div>

<nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar">
    <span class="navbar-brand">Ajout d'objets</span>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Ajouter
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="#" id="addPrefabBanner" onclick="addPremadeObject(1);">Bannière</a>
                    <a class="dropdown-item" href="#" id="addPrefabLogo" onclick="addPremadeObject(2);">Logo</a>
                </div>
            </li>
            <form class="form-inline" style="margin-left:20px;">
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="toggleAdvancedControls();">
                    Montrer contrôles avancés
                </button>
            </form>
            <form class="form-inline" style="margin-left: 20px;">
                <button class="btn btn-success" type="button" onclick="exportSceneToGLB();">
                    Valider objet
                </button>
            </form>
        </ul>
    </div>
</nav>

<div id="panel" class="container">
    <div id="importZone">
        <h5>Glisser & déposer
            <button id="importWarningButton" type="button" class="btn btn-warning btn-sm" onclick="toggleImportWarningPopover();">
                Instructions
            </button>
        </h5>
        <div id="dropZoneObject" ondrop="dropHandlerObject(event);" ondragover="dragOverHandlerObject(event);"
             ondragleave="dragLeaveHandlerObject();">
            <p id="dropTextObject">Importer modèle 3D au format OBJ ou GlTF/GLB (modèle et textures)<!-- <br/> Ou police de charactères (format JSON) -->
            </p>
        </div>
    </div>

    <div id="options">
        Options de l'objet
        <div id="optionColor">
            <h5>Modifier couleur</h5>
            <input type="color" id="objColor" name="objColor"
                   value="#00ff00" onchange="changeColor();">
            <label for="objColor">Couleur</label>
        </div>

        <div id="optionText">
            <h5>Modifier texte</h5>
            <label for="fonts">Police</label>
            <select id="fonts" onchange="changeFont();">
                <option value="helvetiker">helvetiker</option>
                <option value="optimer">optimer</option>
                <option value="gentilis">gentilis</option>
                <option value="droid_sans">droid sans</option>
                <option value="droid_serif">droid serif</option>
            </select>
            <input type="checkbox" id="fontWeight" onchange="changeFontWeight();"> Gras
            <input type="checkbox" id="bevel" onchange="changeBevel();"> Bevel<br/>
            <input type="color" id="textColor" name="objColor"
                   value="#ff0000" onchange="changeColorTextIn();">
            <label for="textColor">Couleur texte</label>
            <input type="color" id="textColorOut" name="objColor"
                   value="#0000ff" onchange="changeColorTextOut();">
            <label for="textColorOut">Couleur contours</label>
        </div>
        <div id="optionOpacity">
            <h5>Modifier transparence</h5>
            0<input type="range" id="objOpacity" min="0" max="1" step="0.0001"
                    value="#00ff00" oninput="changeOpacity();">1
            <label for="objOpacity">Opacité</label>
        </div>
        <!-- <div id="optionAnimation">
            <h5>Animer l'objet</h5>
            <input type="checkbox" id="animRotate" onchange="setAnim(1);">
            <label for="animRotate">Rotation</label>
            <input type="checkbox" id="animFloat" onchange="setAnim(2);">
            <label for="animFloat">Flottement</label>
        </div> -->
    </div>

    <!-- <h5>Importer texture</h5>
    <div id="dropZoneTexture" ondrop="dropHandlerTexture(event);" ondragover="dragOverHandlerTexture(event);"
         ondragleave="dragLeaveHandlerTexture();">
        <p id="dropTextTexture">Glissez et déposez le fichier JPG ou PNG</p>
    </div> -->
    <div id="advancedControls">
        <b style="color: grey;">Contrôles avancés</b>
        <h4>Ajouter forme</h4>
        <button onclick="addCube();">Cube</button>
        <button onclick="addPlane();">Plan</button>
        <button onclick="addCylinder();">Cylindre</button><br/>
        <h4 style="margin-top: 10px;">Ajouter texte</h4>
        <label for="textToAdd">Texte</label>
        <input type="text" id="textToAdd">
        <button onclick="addText();">Ajouter</button><br/>
    </div>
</div>
<script>
    /*
    * All the variables are public to be accessible from others scripts
    */
    //Three.js components
    var camera, scene, renderer, control, orbit, light;
    //We keep track of all objects in the scene, their type and if existing the class that created it
    var objects = [];
    var objects_types = [];
    var objects_class = [];
    var objects_count = 0;
    var selected_object = null;
    //Animation types of objects
    //var objects_anim = [];
    //Stored text of a mesh if its text
    var objects_text = [];

    //Types of objects that can be created
    var myTypes = Object.freeze({"basic":1, "text":2, "importedObject":3, "banner":4, "ellipse":5});

    //Current selected font
    var fontName = "helvetiker", fontWeight = "regular", bevel = false;

    var lastUploadedObjectName = null, lastUploadedTextureName = null;
    var areAdvancedControlsToggled = false;

    //Paths
    const tempStorePath = 'transfer/3dObjects/temp/';
    const prefabStorePath = 'transfer/3dObjects/prefabs';
    const storeFileURL = "transfer/tmpStoreFile";
    const removeFileURL = "transfer/tmpRemoveFiles";
    const storeTextureURL = "transfer/tmpStoreTexture";
    const removeTextureURL = "transfer/tmpRemoveTexture";
    const storeObjectURL = "transfer/storeObject";

    /*const storeFontURL = "storeFont.php";
    const removeFontsURL = "removeFonts.php";*/

    init();
    render();

    //------------------------------------------------------Init & Render
    /*
     * Scene initalization function
     */
    function init() {
        //Create renderer
        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( (window.innerWidth / 2), (window.innerHeight - 20) );
        document.body.appendChild( renderer.domElement );
        //settings for gltf loading
        //renderer.gammaOutput = true;
        //renderer.gammaFactor = 2.2;

        //Create scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color( 0xbfbfbf );
        scene.add( new THREE.GridHelper( 1000, 10 ) );

        //Create camera
        camera = new THREE.PerspectiveCamera( 50, (window.innerWidth / 2) / (window.innerHeight - 20), 1, 5000 );
        camera.position.set( 1000, 500, 1000 );
        camera.lookAt( 0, 200, 0 );

        //Create light
        light = new THREE.DirectionalLight( 0xffffff, 2 );
        light.position.set( 1, 1, 1 );
        scene.add( light );

        //Create space controls
        orbit = new THREE.OrbitControls( camera, renderer.domElement );
        orbit.update();
        orbit.addEventListener( 'change', render );

        //Create object controls
        control = new THREE.TransformControls( camera, renderer.domElement );
        control.addEventListener( 'change', render );
        control.addEventListener( 'dragging-changed', function ( event ) {
            orbit.enabled = ! event.value;
        } );
        scene.add( control );
    }

    /*
     * Scene render function
     */
    function render() {
        renderer.render( scene, camera );

        //For animations, not implemented
        /*for (var i = 0; i < objects_anim.length; i++){
            switch (objects_anim[i]) {
                case 1:
                    objects[i].rotation.y += 0.01;
                    break;
            }
        }*/
    }

    //------------------------------------------------------Popups functions
    /*
     * Create and show a popover for a selected time
     * @param zone : the html component to attach the popover
     * @param text : the popover text
     * @param time : the time in ms before hiding the popover
     * @param html : if the text contains html code to be interpreted
     */
    function showPopupForMilliSeconds(zone, text, time, html){
        $("#" + zone).popover({"content" : text, "trigger" : "manual", "html" : html});
        $("#" + zone).popover('show');
        window.setTimeout(hidePopover, time);

        function hidePopover() {
            $("#" + zone).popover('hide');
        }
    }

    /*
     * Toogle the popover of the import instructions (warning buttons)
     */
    function toggleImportWarningPopover(){
        var text = "<h6>Objets 3D</h6>" + 'Les dossiers ne sont pas supportés, ne placez que des fichiers. ' +
            'Si besoin, modifier les fichiers .gltf ou .mtl pour supprimer le chemin vers les textures et ne garder ' +
            'que les noms des textures.\nL\'éventuel fichier .mtl doit être nommé avec le même nom que le fichier .obj.' +
            '\nLes textures map de 3dsMax ne sont pas supportées.';
               /* "<h6>Police de charactères</h6>" + 'Le fichier de police doit être au format JSON. Il est possible de convertir ' +
            'un fichier de police classique à cette adresse : ' +
            "<a href='https://gero3.github.io/facetype.js'>https://gero3.github.io/facetype.js/</a>"*/
        showPopupForMilliSeconds("importWarningButton", text, 10000, true);
    }

    //------------------------------------------------------Windows events
    /*
     * Windows resize event : resize render canvas
     */
    window.addEventListener( 'resize', onWindowResize, false );
    function onWindowResize() {
        camera.aspect = (window.innerWidth / 2) / (window.innerHeight - 20);
        camera.updateProjectionMatrix();
        renderer.setSize( (window.innerWidth / 2), (window.innerHeight - 20) );
        render();
    }

</script>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="javascripts/libraries/bootbox.js"></script>
<script src="javascripts/libraries/bootbox.locales.js"></script>
<script src="javascripts/libraries/bootbox.all.js"></script>
</body>
</html>